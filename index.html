<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aviator Game</title>
  <style>
    /* --- Basic CSS Styles --- */
    body {
      background-color: #1a1a2e;
      color: #e0e0e0;
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      overflow: hidden;
    }
    .game-container {
      background-color: #2a2a3e;
      border-radius: 10px;
      padding: 15px;
      width: 95%;
      max-width: 400px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
    }
    /* Header Section */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 10px;
      border-bottom: 1px solid #444;
    }
    .header-left {
      display: flex;
      align-items: center;
    }
    /* (No title text) */
    .header-btn {
      background: none;
      border: none;
      color: #ffc107;
      font-size: 1.4em;
      cursor: pointer;
      margin-left: 10px;
    }
    .balance {
      font-size: 1.1em;
      font-weight: bold;
      color: #e0e0e0;
    }
    .balance span#balance-amount {
      color: #28a745;
      margin-left: 5px;
    }
    .balance span.currency {
      color: #aaa;
      font-size: 0.9em;
      margin-left: 3px;
    }
    .history {
      display: flex;
      gap: 5px;
      overflow-x: auto;
      padding: 10px 0;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .history::-webkit-scrollbar {
      display: none;
    }
    .history-item {
      background-color: #444;
      padding: 3px 8px;
      border-radius: 5px;
      font-size: 0.8em;
      white-space: nowrap;
      cursor: default;
    }
    .history-item.low { color: #add8e6; }
    .history-item.medium { color: #ffeb3b; }
    .history-item.high { color: #f44336; }
    .history-item.extreme { color: #9c27b0; }
    .status-message {
      text-align: center;
      font-size: 1.1em;
      padding: 10px 0;
      color: #ffc107;
      min-height: 20px;
      font-weight: bold;
    }
    .game-area {
      background: radial-gradient(circle at bottom left, rgba(0, 120, 255, 0.15), #1a1a2e 70%),
                  linear-gradient(to bottom, #000000, #1a1a2e 70%);
      height: 250px;
      margin: 15px 0;
      border-radius: 8px;
      position: relative;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      border: 1px solid #555;
    }
    .multiplier-display {
      font-size: 3.8em;
      font-weight: bold;
      color: #ffffff;
      text-shadow: 0 0 8px #fff, 0 0 15px #0ff, 0 0 20px #0ff;
      z-index: 3;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .multiplier-display.crashed {
      color: #dc3545;
      text-shadow: 0 0 8px #f00;
    }
    #gameCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    .plane-icon {
      position: absolute;
      width: 60px;
      height: auto;
      z-index: 2;
      bottom: 10px;
      left: 5px;
      transition: bottom 0.1s linear, left 0.1s linear, transform 0.2s linear;
      transform-origin: center center;
      opacity: 0;
      pointer-events: none;
    }
    .plane-icon.cruising {
      animation: wobble 0.5s infinite linear;
    }
    @keyframes wobble {
      0%, 100% { transform: rotate(0deg) translateY(0px); }
      50% { transform: rotate(0deg) translateY(-2px); }
    }
    .controls-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .controls {
      background-color: #3a3a4e;
      border-radius: 8px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .bet-input-area {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .bet-amount-display {
      background-color: #1a1a2e;
      border: 1px solid #555;
      border-radius: 5px;
      padding: 8px 12px;
      flex-grow: 1;
      text-align: left;
      padding-left: 15px;
      font-size: 1.1em;
      position: relative;
    }
    .bet-amount-display span.currency {
      position: absolute;
      right: 10px;
      color: #888;
      font-size: 0.9em;
      top: 50%;
      transform: translateY(-50%);
    }
    .bet-preset-buttons, .bet-adjust-buttons {
      display: flex;
      gap: 5px;
    }
    .bet-adjust-btn, .bet-preset-btn {
      background-color: #555;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 6px 10px;
      font-size: 0.9em;
      cursor: pointer;
      transition: background-color 0.2s;
      flex-grow: 1;
      text-align: center;
    }
    .bet-adjust-btn:hover, .bet-preset-btn:hover {
      background-color: #777;
    }
    .action-button {
      background-color: #28a745;
      color: #fff;
      font-size: 1.2em;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      padding: 12px 0;
      cursor: pointer;
      text-align: center;
      transition: background-color 0.2s, opacity 0.2s;
      text-transform: uppercase;
    }
    .action-button:disabled {
      background-color: #5f6063;
      opacity: 0.7;
      cursor: not-allowed;
    }
    .action-button.cashout {
      background-color: #ff9800;
    }
    .action-button.lost {
      background-color: #dc3545;
      opacity: 0.8;
    }
    .action-button.won {
      background-color: #00bcd4;
      opacity: 0.9;
    }
    .action-button.cancel {
      background-color: #ffc107;
      color: #333;
    }

    /* --- Modal Styles for Bet History --- */
    .modal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.7);
    }
    .modal-content {
      background-color: #2a2a3e;
      margin: 10% auto;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      color: #e0e0e0;
    }
    .close-modal {
      color: #ffc107;
      float: right;
      font-size: 1.5em;
      font-weight: bold;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #555;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #3a3a4e;
    }
  </style>
</head>
<body>
  <!-- Audio Elements for Sound System (update paths as needed) -->
  <audio id="bg-sound" autoplay loop>
    <source src="aviator background sounds .mp3" type="audio/mp3">
  </audio>
  <audio id="sound-start">
    <source src="multiple starting sounds .mp3" type="audio/mp3">
  </audio>
  <audio id="sound-crash">
    <source src="aviator crushing sound .mp3" type="audio/mp3">
  </audio>
  <audio id="sound-cashout">
    <source src="path/to/cashout.mp3" type="audio/mp3">
  </audio>

  <!-- Bet History Modal -->
  <div id="historyModal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2>Bet History</h2>
      <table id="historyTable">
        <thead>
          <tr>
            <th>Panel</th>
            <th>Bet Amount</th>
            <th>Multiplier</th>
            <th>Outcome</th>
            <th>Result</th>
          </tr>
        </thead>
        <tbody>
          <!-- Detailed bet records will be inserted here -->
        </tbody>
      </table>
    </div>
  </div>

  <div class="game-container">
    <div class="header">
      <div class="header-left">
        <!-- Header buttons: Sound Toggle and Bet History -->
        <button id="soundBtn" class="header-btn" title="Toggle Sound">ðŸ”Š</button>
        <button id="historyBtn" class="header-btn" title="View Bet History">ðŸ“œ</button>
      </div>
      <div class="balance">
        Balance: <span id="balance-amount">0.00</span><span class="currency">COINS</span>
      </div>
    </div>

    <div class="history" id="history-bar">
      <!-- History bar (multiplier records) updated during gameplay -->
    </div>

    <div class="status-message" id="status-message">Loading...</div>

    <div class="game-area">
      <div class="multiplier-display" id="multiplier">1.00x</div>
      <canvas id="gameCanvas"></canvas>
      <!-- Plane image always appears on top of the canvas -->
      <img src="https://imgur.com/bSdozZz.png" alt="Plane" class="plane-icon" id="plane">
    </div>

    <div class="controls-container">
      <!-- Bet Panel 1 -->
      <div class="controls" id="controls-1">
        <div class="bet-input-area">
          <div class="bet-amount-display">
            <span id="bet-amount-1">10.00</span> <span class="currency">COINS</span>
          </div>
          <div class="bet-adjust-buttons">
            <button class="bet-adjust-btn" onclick="adjustBet(1, -10, true)">-</button>
            <button class="bet-adjust-btn" onclick="adjustBet(1, 10)">+</button>
          </div>
        </div>
        <div class="bet-preset-buttons">
          <button class="bet-preset-btn" onclick="setBet(1, 100)">100</button>
          <button class="bet-preset-btn" onclick="setBet(1, 200)">200</button>
          <button class="bet-preset-btn" onclick="setBet(1, 500)">500</button>
          <button class="bet-preset-btn" onclick="setBet(1, 1000)">1000</button>
        </div>
        <button class="action-button" id="action-button-1" onclick="handleAction(1)">Bet</button>
      </div>
      <!-- Bet Panel 2 -->
      <div class="controls" id="controls-2">
        <div class="bet-input-area">
          <div class="bet-amount-display">
            <span id="bet-amount-2">10.00</span> <span class="currency">COINS</span>
          </div>
          <div class="bet-adjust-buttons">
            <button class="bet-adjust-btn" onclick="adjustBet(2, -10, true)">-</button>
            <button class="bet-adjust-btn" onclick="adjustBet(2, 10)">+</button>
          </div>
        </div>
        <div class="bet-preset-buttons">
          <button class="bet-preset-btn" onclick="setBet(2, 100)">100</button>
          <button class="bet-preset-btn" onclick="setBet(2, 200)">200</button>
          <button class="bet-preset-btn" onclick="setBet(2, 500)">500</button>
          <button class="bet-preset-btn" onclick="setBet(2, 1000)">1000</button>
        </div>
        <button class="action-button" id="action-button-2" onclick="handleAction(2)">Bet</button>
      </div>
    </div>
  </div>

  <script>
    // --- Global Game Variables ---
    let balance = 0.00; // Initial coin balance (to be managed by the parent system)
    let bets = {
      1: { amount: 10.00, placed: false, cashedOut: false, winMultiplier: 0 },
      2: { amount: 10.00, placed: false, cashedOut: false, winMultiplier: 0 }
    };
    let currentMultiplier = 1.00;
    let gamePhase = 'loading';
    let animationFrameId = null;
    let crashPoint = 1.00;
    let history = [1.05, 1.98, 3.50, 1.23, 10.88, 1.00, 2.45, 6.12, 1.55, 25.3];

    // Array for detailed bet history records
    let betHistoryRecords = [];
    let winCount = 0;
    let lossCount = 0;

    // Sound toggle variable
    let soundEnabled = true;

    // Flight duration: 4000ms (4 seconds)
    const TAKEOFF_DURATION = 4000; 
    const BETTING_DURATION = 5000;
    const POST_CRASH_DELAY = 3000;

    let riseStartTime;

    // --- DOM Elements ---
    const balanceAmountEl = document.getElementById('balance-amount');
    const multiplierEl = document.getElementById('multiplier');
    const statusMessageEl = document.getElementById('status-message');
    const historyBarEl = document.getElementById('history-bar');
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const planeEl = document.getElementById('plane');

    // Sound Elements
    const bgSound = document.getElementById('bg-sound');
    const soundStart = document.getElementById('sound-start');
    const soundCrash = document.getElementById('sound-crash');
    const soundCashout = document.getElementById('sound-cashout');

    // Header Buttons
    const soundBtn = document.getElementById('soundBtn');
    const historyBtn = document.getElementById('historyBtn');

    // Modal Elements for Bet History
    const historyModal = document.getElementById("historyModal");
    const closeModal = document.querySelector(".close-modal");
    const historyTableBody = document.querySelector("#historyTable tbody");

    // --- Event Handlers for Header Buttons ---
    soundBtn.addEventListener("click", () => {
      soundEnabled = !soundEnabled;
      if (soundEnabled) {
        soundBtn.innerHTML = "ðŸ”Š";
        bgSound.muted = false;
        soundStart.muted = false;
        soundCrash.muted = false;
        soundCashout.muted = false;
      } else {
        soundBtn.innerHTML = "ðŸ”‡";
        bgSound.muted = true;
        soundStart.muted = true;
        soundCrash.muted = true;
        soundCashout.muted = true;
      }
    });

    historyBtn.addEventListener("click", () => {
      populateHistoryModal();
      historyModal.style.display = "block";
    });

    closeModal.addEventListener("click", () => {
      historyModal.style.display = "none";
    });
    window.addEventListener("click", (event) => {
      if (event.target == historyModal) {
        historyModal.style.display = "none";
      }
    });

    // --- Utility Functions ---
    function resizeCanvas() {
      const gameArea = canvas.parentElement;
      canvas.width = gameArea.clientWidth;
      canvas.height = gameArea.clientHeight;
      drawGraph();
    }
    window.addEventListener('resize', resizeCanvas);

    function updateBalanceDisplay() {
      balanceAmountEl.textContent = balance.toFixed(2);
    }
    function updateBetDisplay(panelId) {
      const el = document.getElementById(`bet-amount-${panelId}`);
      if (el) el.textContent = bets[panelId].amount.toFixed(2);
    }
    function setBet(panelId, amount) {
      if (gamePhase !== 'betting' || bets[panelId].placed) return;
      bets[panelId].amount = Math.max(1.00, amount);
      updateBetDisplay(panelId);
    }
    function adjustBet(panelId, value, subtract = false) {
      if (gamePhase !== 'betting' || bets[panelId].placed) return;
      if (subtract) bets[panelId].amount = Math.max(1.00, bets[panelId].amount - value);
      else bets[panelId].amount += value;
      updateBetDisplay(panelId);
    }

    // --- Update the bottom history display (multiplier records) ---
    function updateHistoryDisplay() {
      historyBarEl.innerHTML = '';
      const recentHistory = history.slice(-15).reverse();
      recentHistory.forEach(multiplier => {
        const item = document.createElement('span');
        item.classList.add('history-item');
        item.textContent = `${multiplier.toFixed(2)}x`;
        if (multiplier < 1.5) item.classList.add('low');
        else if (multiplier < 5) item.classList.add('medium');
        else if (multiplier < 20) item.classList.add('high');
        else item.classList.add('extreme');
        historyBarEl.appendChild(item);
      });
    }

    // Populate the bet history modal table with detailed records
    function populateHistoryModal() {
      historyTableBody.innerHTML = "";
      betHistoryRecords.forEach(record => {
        let row = document.createElement("tr");
        row.innerHTML = `<td>${record.panel}</td>
                         <td>${record.betAmount.toFixed(2)}</td>
                         <td>${record.multiplier.toFixed(2)}x</td>
                         <td>${record.outcome}</td>
                         <td>${record.result.toFixed(2)}</td>`;
        historyTableBody.appendChild(row);
      });
    }

    // --- Flight Progress Calculation ---
    function getFlightProgress() {
      const elapsed = Date.now() - riseStartTime;
      return Math.min(Math.max(elapsed / TAKEOFF_DURATION, 0), 1);
    }

    // --- Graph Drawing ---
    // During the betting phase, progress = 0 so the graph remains at the bottom-left.
    // The flight path is a straight line with a fixed 0Â° angle.
    function drawGraph() {
      const width = canvas.width;
      const height = canvas.height;
      ctx.clearRect(0, 0, width, height);

      const startX = 15;
      const startY = height - 15;
      // Adjusted end points so that the plane stays away from the top-right corner
      const endX = width - 60;
      const endY = 60;

      let progress = (gamePhase === 'betting') ? 0 : getFlightProgress();

      // Calculate current point along a straight line
      const currentX = startX + progress * (endX - startX);
      const currentY = startY + progress * (endY - startY);

      // Draw background dashed lines
      ctx.save();
      ctx.strokeStyle = 'rgba(120, 160, 255, 0.15)';
      ctx.lineWidth = 1;
      ctx.setLineDash([2, 4]);
      for (let i = 1; i <= 3; i++) {
        ctx.beginPath();
        const yPos = startY - (height * 0.25 * i);
        ctx.moveTo(startX, yPos);
        ctx.lineTo(width - 10, yPos);
        ctx.stroke();
      }
      for (let i = 1; i <= 5; i++) {
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.lineTo(startX + (width / 5) * i, 0);
        ctx.stroke();
      }
      ctx.restore();

      // Draw red filled area below the line
      ctx.beginPath();
      ctx.moveTo(startX, startY);
      ctx.lineTo(currentX, currentY);
      ctx.lineTo(currentX, startY);
      ctx.closePath();
      ctx.fillStyle = 'rgba(220, 53, 69, 0.6)';
      ctx.fill();

      // Draw red line
      ctx.beginPath();
      ctx.moveTo(startX, startY);
      ctx.lineTo(currentX, currentY);
      ctx.strokeStyle = '#dc3545';
      ctx.lineWidth = 4;
      ctx.lineCap = 'round';
      ctx.stroke();

      // Fix plane angle at 0Â° (i.e., the plane flies straight)
      planeEl.style.left = `${currentX - planeEl.width / 2}px`;
      planeEl.style.bottom = `${canvas.height - currentY - planeEl.height / 2}px`;
      planeEl.style.setProperty('--plane-angle', '0deg');
      planeEl.style.transform = 'rotate(0deg)';
    }

    // --- Bet Control Enable/Disable Functions ---
    function disableBetControls(panelId) {
      const controls = document.getElementById(`controls-${panelId}`);
      controls.querySelectorAll('.bet-adjust-btn, .bet-preset-btn').forEach(btn => btn.disabled = true);
    }
    function enableBetControls(panelId) {
      const controls = document.getElementById(`controls-${panelId}`);
      const enable = (gamePhase === 'betting');
      controls.querySelectorAll('.bet-adjust-btn, .bet-preset-btn').forEach(btn => btn.disabled = !enable);
    }

    // --- Flash Status Message ---
    function flashStatusMessage(message, duration = 2000) {
      const originalMessage = statusMessageEl.textContent;
      statusMessageEl.textContent = message;
      statusMessageEl.style.color = '#ffc107';
      setTimeout(() => {
        if (statusMessageEl.textContent === message) {
          let currentPhaseMessage = '';
          switch (gamePhase) {
            case 'betting': currentPhaseMessage = 'Place your bets!'; break;
            case 'preparing': currentPhaseMessage = 'Preparing next round...'; break;
            case 'crashed': currentPhaseMessage = `Crashed @ ${crashPoint.toFixed(2)}x!`; break;
            case 'rising': currentPhaseMessage = 'Flying...'; break;
          }
          statusMessageEl.textContent = currentPhaseMessage;
          statusMessageEl.style.color = '#ffc107';
        }
      }, duration);
    }

    // --- Core Game Logic ---
    function handleAction(panelId) {
      const button = document.getElementById(`action-button-${panelId}`);
      if (gamePhase === 'betting') {
        if (bets[panelId].placed) {
          // Cancel bet
          balance += bets[panelId].amount;
          updateBalanceDisplay();
          bets[panelId].placed = false;
          button.textContent = 'Bet';
          button.classList.remove('cancel');
          enableBetControls(panelId);
          console.log(`Panel ${panelId}: Bet cancelled, ${bets[panelId].amount.toFixed(2)} coins returned`);
        } else {
          // Place bet if balance is sufficient
          if (balance >= bets[panelId].amount && bets[panelId].amount >= 1.00) {
            balance -= bets[panelId].amount;
            updateBalanceDisplay();
            bets[panelId].placed = true;
            bets[panelId].cashedOut = false;
            bets[panelId].winMultiplier = 0;
            button.textContent = 'Cancel';
            button.classList.add('cancel');
            disableBetControls(panelId);
            console.log(`Panel ${panelId}: Bet placed for ${bets[panelId].amount.toFixed(2)} coins. Balance: ${balance.toFixed(2)}`);
          } else if (bets[panelId].amount < 1.00) {
            flashStatusMessage('Minimum bet is 1.00 coin');
          } else {
            flashStatusMessage('Insufficient balance!');
          }
        }
      } else if (gamePhase === 'rising' && bets[panelId].placed && !bets[panelId].cashedOut) {
        // Cash out: record win details, play cashout sound, and update win counter
        bets[panelId].cashedOut = true;
        bets[panelId].winMultiplier = currentMultiplier;
        const winnings = bets[panelId].amount * currentMultiplier;
        balance += winnings;
        updateBalanceDisplay();
        button.textContent = `Won ${winnings.toFixed(2)}`;
        button.classList.remove('cashout');
        button.classList.add('won');
        button.disabled = true;
        winCount++;
        // Record bet detail as a win
        betHistoryRecords.push({
          panel: panelId,
          betAmount: bets[panelId].amount,
          multiplier: currentMultiplier,
          outcome: "Win",
          result: winnings
        });
        if (soundEnabled) {
          soundCashout.currentTime = 0;
          soundCashout.play();
        }
        console.log(`Panel ${panelId}: Cashed out at ${currentMultiplier.toFixed(2)}x, Won: ${winnings.toFixed(2)} coins. Balance: ${balance.toFixed(2)}`);
      }
    }

    let gameLoopTimestamp = 0;
    function gameLoop(timestamp) {
      if (!gameLoopTimestamp) gameLoopTimestamp = timestamp;
      const deltaTime = timestamp - gameLoopTimestamp;
      gameLoopTimestamp = timestamp;

      // Update the multiplier smoothly
      currentMultiplier += (0.01 + (currentMultiplier * 0.015)) * (deltaTime / 1000);
      currentMultiplier = Math.max(1.00, currentMultiplier);
      multiplierEl.textContent = `${currentMultiplier.toFixed(2)}x`;
      drawGraph();

      // Update each bet panel's action button text during rising phase
      Object.keys(bets).forEach(id => {
        const button = document.getElementById(`action-button-${id}`);
        if (bets[id].placed && !bets[id].cashedOut && gamePhase === 'rising') {
          button.textContent = `Cash Out (${(bets[id].amount * currentMultiplier).toFixed(2)})`;
        }
      });

      if (Date.now() - riseStartTime > 3000 && !planeEl.classList.contains('cruising')) {
        planeEl.classList.add('cruising');
      }

      if (currentMultiplier >= crashPoint) {
        endGame();
      } else {
        animationFrameId = requestAnimationFrame(gameLoop);
      }
    }

    function startGame() {
      console.log("--- Starting new round ---");
      gamePhase = 'rising';
      currentMultiplier = 1.00;
      crashPoint = generateCrashPoint();
      console.log(`Crash point set to: ${crashPoint.toFixed(2)}x`);
      multiplierEl.textContent = '1.00x';
      multiplierEl.classList.remove('crashed');
      statusMessageEl.textContent = 'Flying...';
      riseStartTime = Date.now();
      planeEl.style.opacity = 1;
      planeEl.classList.remove('cruising');

      if (soundEnabled) {
        soundStart.currentTime = 0;
        soundStart.play();
        bgSound.currentTime = 0;
        bgSound.play();
      }

      Object.keys(bets).forEach(id => {
        const button = document.getElementById(`action-button-${id}`);
        disableBetControls(id);
        if (bets[id].placed) {
          button.disabled = false;
          button.textContent = 'Cash Out';
          button.classList.remove('cancel');
          button.classList.add('cashout');
        } else {
          button.disabled = true;
          button.textContent = 'Bet';
          button.classList.remove('cancel', 'cashout', 'lost', 'won');
        }
      });

      resizeCanvas();
      gameLoopTimestamp = 0;
      animationFrameId = requestAnimationFrame(gameLoop);
    }

    function generateCrashPoint() {
      const r = Math.random();
      let point = (r < 0.05) ? 1.00 : Math.max(1.01, 1 / (1 - Math.pow(r, 1.5)));
      if (Math.random() < 0.02) point = 15 + Math.random() * 85;
      return point === 1.00 ? 1.00 : Math.max(1.01, point);
    }

    function endGame() {
      if (animationFrameId) cancelAnimationFrame(animationFrameId);
      animationFrameId = null;
      if (gamePhase === 'crashed' || gamePhase === 'preparing') return;

      gamePhase = 'crashed';
      currentMultiplier = crashPoint;
      multiplierEl.textContent = `${crashPoint.toFixed(2)}x`;
      multiplierEl.classList.add('crashed');
      console.log(`--- Round Ended at ${crashPoint.toFixed(2)}x ---`);
      statusMessageEl.textContent = `Crashed @ ${crashPoint.toFixed(2)}x!`;
      planeEl.style.opacity = 0;
      planeEl.classList.remove('cruising');

      // For any bet still placed and not cashed out, record as loss
      Object.keys(bets).forEach(id => {
        const bet = bets[id];
        const button = document.getElementById(`action-button-${id}`);
        button.disabled = true;
        if (bet.placed && !bet.cashedOut) {
          console.log(`Panel ${id}: Lost bet of ${bet.amount.toFixed(2)} coins. Balance: ${balance.toFixed(2)}`);
          button.textContent = 'Lost';
          button.classList.remove('cashout', 'cancel');
          button.classList.add('lost');
          lossCount++;
          // Record bet detail as a loss
          betHistoryRecords.push({
            panel: id,
            betAmount: bet.amount,
            multiplier: currentMultiplier,
            outcome: "Loss",
            result: 0
          });
        } else if (!bet.placed) {
          button.textContent = 'Bet';
          button.classList.remove('cashout', 'lost', 'won', 'cancel');
        }
      });

      if (soundEnabled) {
        bgSound.pause();
        soundCrash.currentTime = 0;
        soundCrash.play();
      }

      history.push(crashPoint);
      updateHistoryDisplay();

      gamePhase = 'preparing';
      statusMessageEl.textContent = `Preparing next round...`;
      setTimeout(prepareNextRound, POST_CRASH_DELAY);
    }

    function prepareNextRound() {
      gamePhase = 'betting';
      statusMessageEl.textContent = `Place your bets! (${(BETTING_DURATION / 1000)}s)`;
      multiplierEl.textContent = '1.00x';
      multiplierEl.classList.remove('crashed');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      planeEl.style.opacity = 0;
      planeEl.style.left = `5px`;
      planeEl.style.bottom = `10px`;
      planeEl.style.transform = 'rotate(0deg)';

      Object.keys(bets).forEach(id => {
        bets[id].placed = false;
        bets[id].cashedOut = false;
        bets[id].winMultiplier = 0;
        const button = document.getElementById(`action-button-${id}`);
        button.disabled = false;
        button.textContent = 'Bet';
        button.classList.remove('cashout', 'lost', 'won', 'cancel');
        enableBetControls(id);
      });

      let countdown = BETTING_DURATION / 1000;
      const countdownInterval = setInterval(() => {
        if (gamePhase !== 'betting') {
          clearInterval(countdownInterval);
          return;
        }
        countdown--;
        if (countdown > 0) {
          statusMessageEl.textContent = `Place your bets! (${countdown}s)`;
        }
        if (countdown <= 0) {
          clearInterval(countdownInterval);
          statusMessageEl.textContent = 'Bets closed! Starting...';
          setTimeout(startGame, 200);
        }
      }, 1000);
      drawGraph();
    }

    // --- Initialization ---
    window.onload = () => {
      gamePhase = 'loading';
      statusMessageEl.textContent = 'Loading Game...';
      updateBalanceDisplay();
      updateBetDisplay(1);
      updateBetDisplay(2);
      updateHistoryDisplay();
      resizeCanvas();
      planeEl.style.opacity = 0;
      console.log("Game loaded. Preparing first round.");
      prepareNextRound();
    };
  </script>
</body>
</html>
